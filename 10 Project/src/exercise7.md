 # Нагрузка, стресс и отказоустойчивость

![testing](materials/ltpt.png)

## Что такое нагрузочное тестирование, тестирование отказоустойчивости и стресс-тестирование? Что их отличает друг от друга?

Виды нефункционального тестирования надежности производительности отличаются по своим целям и задачам, которые они выполняют:

- **Нагрузочное тестирование (load testing)** - проверка работоспособности системы, варьируя постепенный рост нагрузки от минимальной до пиковой. Максимально допустимый показатель указывается в настройках.

> **Цель : определение, насколько приложение или сайт выполняют свои задачи в нормальных условиях и при повышенном количестве запросов (например, для интернет-магазина : минимум одновременной нагрузки в конкретном числе пользователей и расчёт максимально идеального варианта отклика сайта).**
> При тесте создается ожидаемая нагрузка и одновременно определяется время отклика. Например мин. 4000 пользоваталей и отлик не должен не превышать 3 секунд => если оно выше ожидаемого, тогда у сервера при росте посещаемости проблемы, и ваш интернет-магазин будет тормозить.
> * В отличие от нагрузочного, в стресс-тесте нагрузка эмулируется на протяжении длительного промежутка времени, например, на 2-3 часа.

- **Отказоустойчивое тестирование (failover testing)** - проверяет способность системы выделять дополнительные ресурсы и перемещать операции в резервные системы во время сбоя сервера по одной или другим причинам. 

> **Цель: определить, способна ли система обрабатывать дополнительные ресурсы во время критических сбоев (отключение серверов, сбои в сети) или в тот момент, когда система достигает порога производительности. Проводится оценка способности системы сохранять свою работоспособность в условиях неблагоприятных внешних факторов.**
> Используется эмуляция отказов системы или реально вызываемых отказов в управляемом окружении. После вызванного отказа проверяется механизм отказоустойчивости с целью удостовериться, что данные не потеряны или не испорчены, и достигнут оговоренный уровень обслуживания (например, доступности функций или время отклика). Помогает определить уязвимости системы, что особенно важно в системах, работающих в режиме 24/7  т.к. в случае их выхода из строя возможны потери клиентов, репутации, денег и пр.

- **Стресс-тестирование (stress testing)** - определяет «стрессоустойчивость» сервера : в идеале он должен работать при любой нагрузке, тест системы при экстремальных условиях, когда ее ресурсы могут быть исчерпаны.

> **Цель : убедится, что несмотря на медленную работу за пределами допустимой нагрузки сервер не "падает", хоть и работает медленно. (например: проверка что даже при 10000 активных пользователей интернет-магазин функционирует).**
> Ресурсы тарифа хостинга не бесконечные и по мере роста нагрузки наступит момент, при котором сервер будет в не состоянии обработать n-ое количество запросов и при попытке зайти на сайт вылетит соответствующая ошибка запроса. Когда потребление ресурсов превысит их количество, сервер перестанет работать - получаем данные об объеме пропускной способности, т.е. сколько сайт одновременно может принять пользователей.
> * Нагрузка эмулируется, плавно начиная от минимального и заканчивая максимальным значением, при достижении определенного показателя останавливается и измеряется скорость реакции сервера. 

**Сравнительная таблица по подтипам нефункционального тестирования надежности производительности :**

| Тип  | **Нагрузочное тестирование** | **Тестирование отказоустойчивости** | **Стресс-тестирование** |
|---|---|---|---|
| *ENG название* | *Load Testing* | *Failover Testing* | *Stress Testing* |
| **Описание** | Оценка поведения системы при возрастающей нагрузке, целью является определение максимальной нагрузки, которую может выдержать система | Позволяет проверить поведение системы в случает сбоя серверов или при других неблагоприятных факторах | Оценка производительности системы при пороговых значениях рабочей нагрузки или за её пределом |
| **Проверка на :** | Работоспособность при заданной нагрузке | Возможности системы переключения на резервный сервер | Степень устойчивости при экстремальных условиях |
| **Цель теста - оценка :** | Производительности и масштабируемости системы при заданной нагрузке | Готовности системы к аварийным ситуациям и возможности переключения на резерв| Границ возможностей системы при экстремальных условиях |
| **Что мы узнаем по данным** | Сможет ли система обрабатывать запросы в заданное время при заданной нагрузке | Сможет ли система продолжать работу без перерывов в случае сбоя | Какая максимальная нагрузка может быть обработана системой |
|**Вопрос на который отвечает тест**| Достаточно ли быстро работает система в обработке запросов при заданном времени и нагрузке? |  Сможет ли система переместиться сама на другой сервер в случае сбоя основного сервера? | Что произойдет при незапланированной нагрузке? |

## Приведите по одному примеру выполнения каждого из трёх видов тестирования (в контексте проверки базы данных большого веб-приложения).

**Нагрузочное тестирование / Load Testing**
- Цель: определить надежность работы и максимальную нагрузку на БД веб-сайта (лайт версия стресс теста).
1. Определить метрики теста (например, определенное одновременное количество пользователей, мин/макс время ответа, пропускная способность, количество запросов в секунду, проверка состояния сервера/сайта, возникновение и количество ошибок)
2. Настроить тестовое окружение, определив релевантные сценарии (мин. нагрузка, повышение, удержание средней стабильной нагрузки, снижение)
3. Создать документацию : тест-план, описать сценарии, тест-кейсы и пр.
4. Запустить тестирование и установить постепенно увеличивающуюся нагрузку на БД
5. Отследить даннные по сроку выполнения запросов БД и времени получение ответа сервера
6. Измерить производительность БД и пределить максимальный уровень с приемлимым результатом
7. Провести несколько циклов повторног тестирования
8. Оцененить производительность при выбранной нагрузке

**Тестирование отказоустойчивости / Failover Testing**
- Цель: проверить возможности БД веб-сайта при возникновении эксплуатационной проблемы в работе.
1. Определить проблемные сценарии, допустимые пределы порчи данных
2. Создать документацию : тест-план, описать сценарии, тест-кейсы и пр.
3. Симулировать сбой данных (обесточивание - отказ электричества или рабочих носителей данных, прерывание работы или синхронизации)
4. Оценить как быстро система восстановилась после перезагрузки, возникновение ошибок
5. Проверить возможное повреждение данных, что было утеряно в результате сбоя
6. Получить отчет с указанием процессов/транзакций, которые не были завершены 
7. По результатам работы систем восстановления оценить как система прошла тест

**Стресс-тестирование / Stress Testing**
- Цель: проверить стабильность работы БД веб-сайта в период чрезмерной нагрузки, доходя до предела выносливости системы и прочности сервера (экстремальный вариант нагрузочного).
1. Определить сценарии и функции, которые могут вызвать отказ системы (например, максимальное количество пользователей/запросов, а также совершение большого числа одинаковых/разных действий)
2. Создать документацию : тест-план, описать сценарии, тест-кейсы и пр.
3. Запустить тестирование на нескольких устройствах с разными параметрами
4. Установить «точку отказа» допустимую системой, а также превышающее граничное значение (система не отвечает)
5. Провести несколько циклов тестов, контролируя окружение
6. Оценить поведение системы БД при этой определенной максимальной нагрузке
7. Проверить, что при сбое система отвечает правильным сообщением об ошибке
7. Проверить возможность возникновения угроз безопасности, утечек памяти БД после перезапуска при сбое

## С помощью каких инструментов можно провести нагрузочное тестирование базы данных?

| Название | Описание программы |  
|---|---|
| **Apache JMeter** | Популярный инструмент с открытым исходным кодом (open-source) в области тестирования производительности. Это Java-приложение, созданное специально для нагрузочного тестирования с возможностью измерения производительности приложений и времени отклика.JMeter основан на ресурсоемкой потоковой архитектуре, имеет много плагинов Есть возможность тестирования производительности множества технологий с использованием ряда протоколов (HTTP/HTTPS, SOAP и Rest Services, FTP, базы данных с JDBC). Есть настройки для тестирования производительности мобильных приложений. С ver/3.1. язык программирования по умолчанию стал Groovy. |  
| **Taurus** | С технической точки зрения не является инструментом нагрузочного тестирования - работает над другими решениями. Позволяет писать тесты на YAML. Полноценный сценарий можно описать примерно в десяти строках текста, а это дает командам возможность описывать свои тесты в файлах YAML или JSON т.о. используя удобочитаемые описания тестов в простых текстовых файла без создания больших и специфических инструментов. Предоставляет своего рода слой абстракции поверх JMeter, так же, как и некоторые другие инструменты (например, Locust, Gatling, Grinder и Selenium).|  
| **Locust** | Простой в использовании распределенный инструмент нагрузочного тестирования. Он может помочь вам определить время отклика и выяснить, сколько пользователей способна обрабатывать система одновременно. В качестве языка сценариев используется Python. Locust использует событийно-ориентированный подход, потребляющий меньше ресурсов. Можно легко масштабировать количество пользователей, которых вам нужно эмулировать. Использует генератор нагрузки “swarm” (locust /саранча, а swarm/рой). т.е. направляет “рой саранчи” на сайт и для каждого из экземпляров можно отдельно определить желаемое поведение. Это дает возможность отслеживать процесс “роения” в режиме реального времени в веб-интерфейсе. Подходит для тестирования API. |  
| **Fiddler с BlackWidow и Watcher** | Связка для быстрого запуска автоматизированного тестирования производительности.Fiddler - популярный инструмент среди разработчиков для захвата трафика, отладки сервиса и просмотра HTTP-запросов - сам по себе не решение для нагрузочного тестирования, но | у него есть много функций, позволяющих отлаживать проблемы с сайтом. Watcher - это надстройка безопасности для Fiddler. Этот инструмент выявляет проблемы безопасности в веб-приложении. BlackWidow - это веб-краулер. Вы можете указать ему веб-адрес и получить подробную информацию по этому адресу. 
| **nGrinder** | Решение для инженерии производительности корпоративного уровня. Он был создан для упрощения стресс-тестирования и как платформа, позволяющая создавать, выполнять и отслеживать тесты. |  
| **The Grinder** | Фреймворк на основе Java. Он предоставляет простые в использовании решения для распределенного тестирования с использованием множества машин-генераторов нагрузки для определения времени отклика конечных пользователей, где не придется беспокоиться о каких-либо ограничениях виртуальных пользователей. |
| **Gatling** | Инструмент нагрузочного тестирования, написанный на Scala и построенный на базе Akka и Netty. Позволяет тестировать и измерять сквозную производительность  приложения и легко масштабировать виртуальных пользователей. |  
| **k6** | Ориентированный на разработчиков инструмент нагрузочного тестирования для  вашей внутренней инфраструктуры. Его также можно использовать для включения тестирования производительности в CI/CD-пайплайны. Создан с использованием Go и JavaScript, поэтому хорошо интегрируется в рабочий процесс большинства разработчиков. Обеспечивает распределенное и облачное исполнение и возможность оркестровки REST API. |
| **Tsung** | Распределенная система нагрузочного тестирования, написанная на Erlang. Имеет высокую производительность (симулировать огромное число пользователей: тысячи на одном CPU + разные типы), нагрузка может быть распределена на кластер клиентских машин; рассматривает динамические сценарии с сервера под нагрузкой (без написания какого-либо кода) и позволяет использовать их в последующих запросах. Поддерживаются протоколы HTTP, XMPP, LDAP и т. д. |  
| **Siege** | Утилита командной строки для нагрузочного тестирования HTTP и тестирования производительности. Она призвана помочь разработчикам в оценке производительности их кода в условиях стрессовой нагрузки. Поддерживает базовую аутентификацию, файлы cookie, протоколы HTTP, HTTPS и FTP. Позволяет своим пользователям подключаться к серверу с настраиваемым количеством симулированных клиентов. Эти клиенты берут сервер в «осаду» (англ. siege — осада). |  
| **Bees with Machine Guns** | «Пчелы с пулеметами» - это утилита разработкк Chicago Tribune для вооружения (создания) множества пчел (микроэкземпляры Amazon EC2) для атаки (нагрузочный тест) целей (веб-приложений). Может помочь вам провести нагрузочное тестирование сайта, который должен обрабатывать высокий трафик. Позволяет ввести пару команд и симулировать трафик, приходящий из нескольких разных источников (разные IP-адреса), что более эффективно для тестирования балансировки нагрузки при замере производительности. |  
| **Fortio** | Библиотека для нагрузочного тестирования, инструмент командной строки, расширенный эхо-сервер и веб-интерфейс. Написан на языке Go. Позволяет задать посекундную нагрузку и записывать гистограммы задержки и другую полезную статистику .Быстрый и компактный (Docker-образ 3 МБ, мин. зависимости). Пригоден для многоразового использования. Развитый и надежный инструмен. | 
| **Puppeteer** | Библиотека Node, предлагающая высокоуровневый API для управления браузером Chrome или Chromium без пользовательского интерфейса, поверх протокола DevTools. Актуальна в тестировании производительности фронтенда. Используется для сбора статистики веб-производительности (например, для отслеживания загрузки страницы), получения трассировки DevTools со снимками экрана, получения показателей производительности во время выполнения. |  
| **Flood Element** | Масштабируемый  инструмент нагрузочного тестирования с использованием реальных браузеров. Такой подход позволяет более точно имитировать то, как реальные пользователи взаимодействуют с вашим приложением. Генерирует нагрузку путем запуска тысяч экземпляров Chromium, Firefox или Webkit. В ходе тестирования можно делать все так же, как делают реальные пользователи, открывая браузер и взаимодействуя с элементами страницы. Это может помочь найти проблемы, с которыми сталкивается пользователь. Создан на основе библиотеки автоматизации Playwright, благодаря чему отличается высокой скоростью и кроссбраузерной поддержкой.  Сценарии создаются с использованием TypeScript. |  
| **Artillery** | Open-source приложение с премиум-сервисами, позволяющими создавать нагрузочные тесты для имитации нагрузки от тысяч пользователей. Предоставляет подробные отчеты о разных показателях производительности: задержках, запросах в секунду, конкурентности, среднем времени отклика, пропускной способности. Позволяет прописывать пользовательскую логику и сценарии предварительного тестирования с использованием JavaScript, который имеет широкий спектр доступных NPM-модулей. Поддерживает несколько протоколов, включая HTTP, Web Socket, Socket.IO, Kinesis и HLS. |  

## Какие существуют способы оптимизации (улучшения производительности) базы данных?

- **Индексация** : создание индексов, которые используют ключевые части данных из таблицы в двоичной структуре для улучшения функции поиска повыщает эффективность т.к. ускоряет проведение поиск и извелечение записи из БД, облегчает упорядоченную сортировку данных (указатель на исходные строки).

- **Нормализация** : меняется способ организации данных в БД без дублирования, чтобы они занимали меньше места, а поиск по элементам был быстрым и результативным; создаются дополнительные таблицы и связывают друг с другом ключами - колонками, в которых нет повторяющихся элементов.

- **Оптимизация доступа к данным: кэширование** : использование кэша последовательностей и отдельных табличных пространств для больших таблиц. Можно задать применимые размеры страниц и емкости хранения для этих табличным пространств и кэш-памяти для оптимальной производительности.

- **Изменение размеров кэшей последовательностей** (последовательность - это объект БД, автоматически генерирующий уникальные значения ключей) : т.к. последовательность может генерировать одно значение за один раз и кэш нескольких значений, благодаря использованию кэшей процессы могут получить значения из него, не ожидая последовательности для генерации отдельных значений.

- **Оптимизация запросов** : ускорить запросы SQL с помощью оптимизаторов запросов с использованием эффективных

- **Обновить оборудование** : улучшение мощностей процессора - чем лучше, тем быстрее и эффективнее будет БД, следовательно меньше нагрузка при работе с несколькими приложениями и запросами. 

- **Выделение большего числа памяти** : увеличить объём памяти выделяемой на обработку запросов, при нехватке памяти БД для выполнения запрашиваемой работы, производительность пойдет на спад. 

- **Дефрагментация данных** : позволит сгруппировать соответствующие данные, поэтому операции, связанные с вводом/выводом, будут выполняться быстрее, что напрямую повлияет на общую производительность запросов и БД.
 
- **Обновить версию базы данных** : актуализация до последней версии может существенно повлиять на общую производительность БД.